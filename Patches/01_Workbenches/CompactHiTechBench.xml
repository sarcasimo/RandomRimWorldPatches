<?xml version="1.0" encoding="utf-8" ?>
<Patch>

  <!-- Add compact hi-tech research bench as new item -->
  <Operation Class="PatchOperationAdd">
    <xpath>Defs</xpath>
    <value>
      <ThingDef ParentName="BenchBase">
        <defName>HiTechResearchBenchCompact</defName>
        <label>compact hi-tech research bench</label>
        <description>A space-efficient hi-tech research bench. Smaller footprint but higher material cost. Compatible with all research facility enhancements.</description>
        <thingClass>Building_ResearchBench</thingClass>
        
        <!-- Compact size -->
        <size>(3,1)</size>
        <graphicData>
          <texPath>Things/Building/Production/HiTechResearchBench</texPath>
          <graphicClass>Graphic_Multi</graphicClass>
          <drawSize>(3.5,1.5)</drawSize>
          <damageData>
            <cornerTL>Damage/Corner</cornerTL>
            <cornerTR>Damage/Corner</cornerTR>
            <cornerBL>Damage/Corner</cornerBL>
            <cornerBR>Damage/Corner</cornerBR>
          </damageData>
        </graphicData>
        
        <castEdgeShadows>true</castEdgeShadows>
        <staticSunShadowHeight>0.20</staticSunShadowHeight>
        <fillPercent>0.5</fillPercent>
        <useHitPoints>True</useHitPoints>
        <designationCategory>Production</designationCategory>
        <passability>PassThroughOnly</passability>
        <pathCost>50</pathCost>
        
        <!-- Higher cost to balance the space advantage -->
        <costList>
          <Steel>200</Steel>
          <ComponentIndustrial>8</ComponentIndustrial>
          <Plasteel>40</Plasteel>
          <ComponentSpacer>2</ComponentSpacer>
        </costList>
        
        <statBases>
          <MaxHitPoints>180</MaxHitPoints>
          <WorkToBuild>20000</WorkToBuild>
          <Flammability>1.0</Flammability>
          <ResearchSpeedFactor>1.0</ResearchSpeedFactor>
          <Mass>35</Mass>
        </statBases>
        
        <comps>
          <li Class="CompProperties_Power">
            <compClass>CompPowerTrader</compClass>
            <basePowerConsumption>250</basePowerConsumption>
            <shortCircuitInRain>true</shortCircuitInRain>
          </li>
          <li Class="CompProperties_Flickable"/>
          
          <!-- Auto-discovery compatible facility setup -->
          <li Class="CompProperties_AffectedByFacilities">
            <linkableFacilities>
              <!-- Vanilla facilities - these are what modded facilities search for -->
              <li>ToolCabinet</li>
              <li>MultiAnalyzer</li>
              <!-- Modded facilities will auto-add themselves via XPath patches -->
            </linkableFacilities>
          </li>
          
          <li Class="CompProperties_Facility">
            <statOffsets>
              <ResearchSpeedFactor>0.1</ResearchSpeedFactor>
            </statOffsets>
            <maxSimultaneous>1</maxSimultaneous>
            <mustBePlacedAdjacent>true</mustBePlacedAdjacent>
          </li>
        </comps>
        
        <placeWorkers>
          <li>PlaceWorker_ShowFacilitiesConnections</li>
          <li>PlaceWorker_ReportWorkSpeedPenalties</li>
        </placeWorkers>
        
        <researchPrerequisites>
          <li>HiTechResearchBench</li>
        </researchPrerequisites>
        
        <constructionSkillPrerequisite>8</constructionSkillPrerequisite>
        
        <!-- Make it minifiable like the resized mod does -->
        <minifiedDef>MinifiedThing</minifiedDef>
        <thingCategories>
          <li>BuildingsProduction</li>
        </thingCategories>
        
        <inspectorTabs>
          <li>ITab_Bills</li>
        </inspectorTabs>
        
        <building>
          <spawnedConceptLearnOpportunity>BillsTab</spawnedConceptLearnOpportunity>
          <buildingTags>
            <li>Production</li>
            <li>Research</li>
          </buildingTags>
        </building>
        
        <designationHotKey>Misc4</designationHotKey>
      </ThingDef>
    </value>
  </Operation>

  <!-- Reverse compatibility: Make any facility that links to vanilla HiTechResearchBench also link to compact version -->
  <Operation Class="PatchOperationAdd">
    <xpath>(/Defs/thingDef | /Defs/ThingDef)/comps/li[@Class="CompProperties_Facility"]/linkableTo[./li[text()="HiTechResearchBench"]]</xpath>
    <value>
      <li>HiTechResearchBenchCompact</li>
    </value>
  </Operation>

</Patch>
